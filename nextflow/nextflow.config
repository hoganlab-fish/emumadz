// EMUMADZ Pipeline - Simplified Configuration
// Minimal configuration focusing on essentials

// Global defaults
process {
    cpus = 16
    memory = '32.GB'
    errorStrategy = 'retry'
    maxRetries = 2
}

// Process-specific overrides (only when needed)
process {
    // GATK processes need more memory
    withName: 'call_variants' {
        memory = '80.GB'
    }
    
    withName: 'apply_stringent_filters' {
        memory = '80.GB'
    }
    
    // VEP and snpEff need more memory for annotation
    withName: 'annotate_vep' {
        memory = '32.GB'
    }
    
    withName: 'annotate_snpeff' {
        memory = '32.GB'
    }
    
    // BAM subsetting can be memory intensive
    withName: 'prepare_visualization' {
        memory = '16.GB'
    }
}

// Execution profiles
profiles {
    local {
        process.executor = 'local'
    }
    
    slurm {
        process.executor = 'slurm'
        process.queue = 'normal'
    }
    
    docker {
        docker.enabled = true
    }
    
    singularity {
        singularity.enabled = true
    }
    
    // Test profile for container validation
    test_containers {
        // Test profile settings
        params.config_profile_description = 'Test profile to validate container images and tool installations'
        params.config_profile_contact     = 'Tyrone Chen (Bioinformatics Core)'
        params.config_profile_url         = "https://www.petermac.org/"
        
        process.executor = 'local'
        process.cpus = 1
        process.memory = '4.GB'
        
        apptainer.enabled = true
        apptainer.autoMounts = true
        apptainer.cacheDir = "/config/binaries/singularity/containers_devel/nextflow"
        
        // Test specific containers
        withName: 'test_gatk' {
            container = 'broadinstitute/gatk:4.6.2.0'
        }
        
        withName: 'test_bcftools' {
            container = 'staphb/bcftools:1.22'
        }
        
        withName: 'test_vep' {
            container = 'ensemblorg/ensembl-vep:release_109.3'
        }
        
        withName: 'test_snpeff' {
            container = 'staphb/snpeff:5.2f'
        }
        
        withName: 'test_pysam' {
            container = 'tyronechen/pysam_pandas'
        }
    }
    
    // PeterMac HPC profile
    petermac {
        // PeterMac-specific settings
        params.config_profile_description = 'Peter MacCallum Cancer Centre (PeterMac) Rosalind HPC (RHEL9) cluster profile'
        params.config_profile_contact     = 'Richard Lupat (@rlupat)'
        params.config_profile_url         = "https://www.petermac.org/"
        params.max_memory = 300.GB
        params.max_cpus = 40
        params.max_time = 336.h
        
        process.executor = 'slurm'
        process.queue = { 
            task.time < 2.h ? 'rhel_2hr' : 
            task.time < 24.h ? 'rhel_short' : 
            'rhel_long' 
        }
        process.cache = 'lenient'
        process.stageInMode = 'symlink'
        
        apptainer.enabled = true
        apptainer.autoMounts = true
        apptainer.cacheDir = "/config/binaries/singularity/containers_devel/nextflow"
        
        executor.queueSize = 84
        executor.queueStatInterval = '1 min'
        executor.pollInterval = '2 min'
        executor.submitRateLimit = '20 min'
        
        cleanup = true
    }
}

// Reporting
report.enabled = true
timeline.enabled = true
trace.enabled = true
dag.enabled = true

plugins {
  id 'nf-co2footprint@1.0.0-rc'
}
