<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src-elem 'self' 'unsafe-inline'; worker-src 'self' blob:; connect-src 'self' *; img-src 'self' data: *"> -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <title>EMUMADZ Variant Analysis Viewer</title>
    <script src="/api/igv-proxy/igv.min.js"></script>
    <link rel="stylesheet" href="/api/igv-proxy/igv.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: auto;
            resize: both;
        }
        
        .header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: 2px;
        }
        
        .controls {
            padding: 25px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }
        
        .control-group input, .control-group select {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }
        
        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 10px 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.3);
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: white;
            color: #495057;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 25px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        th, td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            white-space: nowrap;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.8rem;
        }
        
        .impact-high { background-color: rgba(255, 0, 0, 0.1); }
        .impact-moderate { background-color: rgba(255, 140, 0, 0.1); }
        .impact-low { background-color: rgba(50, 205, 50, 0.1); }
        .impact-modifier { background-color: rgba(135, 206, 235, 0.1); }

        .frozen-col {
            position: sticky;
            background: #f8f9fa !important;
            border-right: 2px solid #dee2e6;
        }
        
        .frozen-col:first-child {
            left: 0;
            min-width: 140px;
            z-index: 20;
        }
        
        .frozen-col:nth-child(2) {
            left: 140px;
            min-width: 120px;
            z-index: 20;
        }
        
        tbody .frozen-col {
            background: white !important;
        }
        
        .vep-header, .vep-col {
            background: #e3f2fd !important;
            border-right: 1px solid #bbdefb;
        }

        .snpeff-header, .snpeff-col {
            background: #f3e5f5 !important;
            border-right: 1px solid #ce93d8;
        }

        tbody .vep-col {
            background: #f8fcff !important;
        }

        tbody .snpeff-col {
            background: #faf9fb !important;
        }

        .igv-container {
            width: 100%;
            min-height: 400px;
            /* height: 50vh; Responsive: 50% of viewport height */
            /* max-height: 80vh; */
            /* border: 1px solid #dee2e6; */
            border-radius: 8px;
            margin-top: 20px;
            box-sizing: border-box;
            /* Remove resize and overflow for full width */
        }        

        .gosling-container {
            height: 500px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .annotation-group {
            border-right: 2px solid #e9ecef;
            padding-right: 10px;
        }

        .tooltip-container {
            position: relative;
            display: inline-block;
            margin-left: 5px;
        }

        .tooltip-icon {
            display: inline-block;
            width: 14px;
            height: 14px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 10px;
            font-weight: bold;
            cursor: help;
            line-height: 14px;
        }

        .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: #2c3e50;
            color: white;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85em;
            line-height: 1.4;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #2c3e50 transparent transparent transparent;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>EMUMADZ Variant Analysis Viewer F0-F2</h1>
            <div id="sampleInfo" style="display:none; margin-top: 10px; font-size: 1.1rem; opacity: 0.9;"></div>
            <button class="btn" id="backToFilesBtn" style="display:none; margin-top: 10px;" onclick="showFileList()">← Back to File Landing Page</button>
        </div>

        <div id="file-list-view">
            <h2 style="text-align:center; margin-top:20px;">File Landing Page</h2>
            <div class="table-container">
                <table id="fileListTable">
                    <thead>
                        <tr>
                            <th>Sample Name</th>
                            <th>Size</th>
                            <th>Modified</th>
                            <th>Action</th>
                            <th>File Name</th>
                        </tr>
                    </thead>
                    <tbody id="fileListBody">
                        <tr><td colspan="5" class="loading">Loading available files...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
                
        <div id="variant-view" style="display: none;">
            <div class="controls">
                <span id="currentFileName" style="font-weight: bold; margin-right: 20px;"></span>
                
                <div class="control-group">
                    <label>Reference Genome:
                        <div class="tooltip-container">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">Select the reference genome assembly for IGV visualization. Different assemblies have different chromosome coordinates and annotations.</span>
                        </div>
                    </label>
                    <select id="genomeSelect">
                        <option value="danRer7">Zebrafish (danRer7/Zv9)</option>
                        <option value="danRer10">Zebrafish (danRer10)</option>
                        <option value="danRer11">Zebrafish (danRer11)</option>                        
                        <option value="hg38">Human (hg38)</option>
                        <option value="hg19">Human (hg19)</option>
                        <option value="mm10">Mouse (mm10)</option>
                        <option value="dm6">Drosophila (dm6)</option>
                        <option value="ce11">C. elegans (ce11)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Chromosome:
                        <div class="tooltip-container">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">Filter variants by specific chromosome or scaffold. Useful for focusing on particular genomic regions.</span>
                        </div>
                    </label>
                    <select id="chromosomeFilter">
                        <option value="">All Chromosomes</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Impact:
                        <div class="tooltip-container">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">Filter by predicted functional impact:<br>• HIGH: Protein truncating (stop gained, frameshift)<br>• MODERATE: Missense, in-frame indels<br>• LOW: Synonymous variants<br>• MODIFIER: Intronic, intergenic variants</span>
                        </div>
                    </label>
                    <select id="impactFilter">
                        <option value="">All Impacts</option>
                        <option value="HIGH">High</option>
                        <option value="MODERATE">Moderate</option>
                        <option value="LOW">Low</option>
                        <option value="MODIFIER">Modifier</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Gene:
                        <div class="tooltip-container">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">Search for variants in specific genes. Supports partial matches and searches both VEP and SnpEff gene annotations.</span>
                        </div>
                    </label>
                    <input type="text" id="geneFilter" placeholder="Search genes...">
                </div>
                
                <div class="control-group">
                    <label>Min Depth:
                        <div class="tooltip-container">
                            <span class="tooltip-icon">?</span>
                            <span class="tooltip-text">Minimum sequencing depth required. Higher depth generally indicates more confident variant calls. Typical thresholds: 10-20x for diploid, 30-50x for high confidence.</span>
                        </div>
                    </label>
                    <input type="number" id="depthFilter" min="0" placeholder="0">
                </div>
                
                <button class="btn" onclick="applyFilters()">Apply Filters</button>
                <button class="btn" onclick="clearFilters()">Clear</button>
                <button class="btn" id="refreshIGVBtn" onclick="forceIGVRefresh()">Refresh IGV</button>
            </div>
            
            <p>
                <span style="color: #0000ff"><em>Contact tyrone if you experience any bugs or have a feature request. In both cases please provide as much information as possible (e.g. steps taken to reproduce a problem). Screenshots may be helpful. Routine (mainly technical) testing was already done, but some bugs may remain.</em></span>
            </p>

            <div class="tabs">
                <button class="tab active" onclick="showTab('table')">Variant Table</button>
                <button class="tab" onclick="showTab('igv')">IGV Browser</button>
                <button class="tab" onclick="showTab('gosling')">Gosling Plots</button>
            </div>
            
            <div id="table-tab" class="tab-content active">
                <div class="help-section" style="background: #f8f9fa; padding: 20px; margin-bottom: 20px; border-radius: 8px; border-left: 4px solid #667eea;">
                    <h4 style="margin: 0 0 10px 0; color: #495057;">Sample Analysis Overview</h4>
                    <p style="margin: 0; color: #6c757d; line-height: 1.5;">
                        This table displays annotated variants from your sample with both VEP and SnpEff predictions. 
                        Use the filters above to narrow results by chromosome, impact level, gene name, or sequencing depth. 
                        Click "IGV" to visualize variants in context with BAM alignments. "Gosling" functionality is currently not enabled. 
                    </p>
                </div>                
                <div class="stats" id="stats"></div>
                <div class="table-container">
                    <table id="variantTable">
                        <thead>
                            <tr>
                                <th class="frozen-col">Variant ID</th>
                                <th class="frozen-col">Actions</th>
                                <th>Genotype</th>
                                <th>Depth</th>
                                <th>AF</th>
                                <th class="vep-header">VEP Gene</th>
                                <th class="snpeff-header">SnpEff Gene</th>
                                <th class="vep-header">VEP Impact</th>
                                <th class="snpeff-header">SnpEff Impact</th>
                                <th class="vep-header">VEP Consequence</th>
                                <th class="snpeff-header">SnpEff Effect</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr><td colspan="11" class="loading">Load a JSON file to view variants</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="igv-tab" class="tab-content">
                <div class="help-section" style="background: #f8f9fa; padding: 20px; margin-bottom: 20px; border-radius: 8px; border-left: 4px solid #667eea;">
                    <h4 style="margin: 0 0 10px 0; color: #495057;">Sample Analysis Overview</h4>
                    <p style="margin: 0; color: #6c757d; line-height: 1.5;">
                        Note that the tracks shown may not always appear to conform to your filters for genotype, depth and allele frequency.
                        This is not an error. The tracks include reads of all quality levels by design to provide the maximum possible level of information.
                        Clicking on the individual reads will yield more information on mapping quality and other read-specific information. 
                        Note that reads with low mapping quality or phred score were naturally excluded from the allele frequency calculations, even if they appear on the tracks.
                        <span style="color: #ff0000">The custom genome annotation coordinates reflects the zebrafish genome assembly Zv9 only. Newer genome versions are provided for testing purposes only and should not be used for this experiment. Automated checks for annotation file compatibility will be implemented later.</span>
                    </p>
                </div>                 
                <div id="igv-info" style="display:none; background: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong id="igv-variant-id"></strong> | <span id="igv-coordinates"></span>
                            <div style="font-size: 0.9em; color: #6c757d; margin-top: 5px;" id="igv-gene-info"></div>
                        </div>
                        <div>
                            <button class="btn" onclick="fitIGVTracks()" style="font-size: 0.8em; padding: 6px 12px; margin-right: 5px;">Fit Tracks
                                <div class="tooltip-container" style="display: inline-block; margin-left: 3px;">
                                    <span class="tooltip-icon" style="font-size: 8px; width: 12px; height: 12px; line-height: 12px;">?</span>
                                    <span class="tooltip-text">Attempt to resize all tracks to show the full scope of reads and features without scrolling.</span>
                                </div>
                            </button>
                            <button class="btn" onclick="resetIGVTracks()" style="font-size: 0.8em; padding: 6px 12px;">Reset Height
                                <div class="tooltip-container" style="display: inline-block; margin-left: 3px;">
                                    <span class="tooltip-icon" style="font-size: 8px; width: 12px; height: 12px; line-height: 12px;">?</span>
                                    <span class="tooltip-text">Reset all tracks to their default viewing height (250px for BAM, 100px for annotations).</span>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="igv-container" id="igvDiv"></div>
            </div>
            
            <div id="gosling-tab" class="tab-content">
                <div class="gosling-container" id="goslingDiv"></div>
            </div>
        </div>
    </div>

    <script>
        let variantData = [];
        let filteredData = [];
        let igvBrowser = null;
        let fileList = [];
        let genomeConfig = null;
        
        // Auto-load file list on page load
        window.addEventListener('load', loadFileList);
        
        // Load file list from server
        function loadFileList() {
            fetch('/api/files')
                .then(response => response.json())
                .then(files => {
                    fileList = files;
                    displayFileList();
                })
                .catch(error => {
                    console.error('Error loading file list:', error);
                    document.getElementById('fileListBody').innerHTML = 
                        '<tr><td colspan="5" style="color: red;">Error loading files. Check server connection.</td></tr>';
                });
        }
        
        function displayFileList() {
            const tbody = document.getElementById('fileListBody');
            
            if (fileList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">No JSON files found in data directory</td></tr>';
                return;
            }
            
            tbody.innerHTML = fileList.map(file => {
                // Extract sample name from filename (remove .json extension and clean up)
                const sampleName = file.name.replace('.json', '').replace(/[_-]/g, ' ');
                
                return `
                    <tr>
                        <td><strong>${sampleName}</strong></td>
                        <td>${formatFileSize(file.size || 0)}</td>
                        <td>${file.modified ? new Date(file.modified).toLocaleString() : '-'}</td>
                        <td>
                            <button class="btn" style="font-size: 0.8em; padding: 6px 12px;" onclick="loadVariantFile('${file.name}')">Load</button>
                        </td>
                        <td>${file.name}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        function loadVariantFile(filename) {
            fetch(`/data/${filename}`)
                .then(response => response.json())
                .then(data => {
                    variantData = data;
                    filteredData = [...variantData];
                    document.getElementById('currentFileName').textContent = filename;
                    // Update sample info in header
                    if (data.length > 0) {
                        const sampleName = data[0].sample_id || filename.replace('.json', '');
                        document.getElementById('sampleInfo').textContent = `Sample: ${sampleName}`;
                        document.getElementById('sampleInfo').style.display = 'block';
                    }                    
                    showVariantView();
                    populateFilters();
                    updateTable();
                    updateStats();
                })
                .catch(error => {
                    alert('Error loading file: ' + error.message);
                });
        }
        
        function showFileList() {
            document.getElementById('file-list-view').style.display = 'block';
            document.getElementById('variant-view').style.display = 'none';
            document.getElementById('backToFilesBtn').style.display = 'none';
            document.getElementById('sampleInfo').style.display = 'none';
        }

        function showVariantView() {
            document.getElementById('file-list-view').style.display = 'none';
            document.getElementById('variant-view').style.display = 'block';
            document.getElementById('backToFilesBtn').style.display = 'inline-block';
        }

        // Check if annotation track matches selected genome
        function checkGenomeAnnotationCompatibility(selectedGenome, genomeConfig) {
            if (!genomeConfig || !genomeConfig.genome) {
                return true; // No genome info available, allow track
            }
            
            const annotationGenome = genomeConfig.genome.toLowerCase();
            const selected = selectedGenome.toLowerCase();
            
            // Define compatible genome groups
            const compatibilityMap = {
                'danrer7': ['danrer7', 'zv9'],
                'danrer10': ['danrer10', 'grcz10'],
                'danrer11': ['danrer11', 'grcz11'],
                'hg38': ['hg38', 'grch38'],
                'hg19': ['hg19', 'grch37'],
                'mm10': ['mm10', 'grcm38'],
                'dm6': ['dm6', 'bdgp6'],
                'ce11': ['ce11', 'wbcel235']
            };
            
            // Check if selected genome has a compatibility group
            const compatibleVersions = compatibilityMap[selected];
            if (compatibleVersions) {
                return compatibleVersions.some(version => annotationGenome.includes(version));
            }
            console.log(compatibleVersions)
            // Fallback: check if annotation genome contains selected genome name
            return annotationGenome.includes(selected) || selected.includes(annotationGenome);
        }

        // Force IGV refresh function
        async function forceIGVRefresh() {
            const selectedGenome = document.getElementById('genomeSelect').value || 'danRer7';
            const igvDiv = document.getElementById('igvDiv');
            
            try {
                // Show loading overlay
                igvDiv.insertAdjacentHTML('beforeend', '<div class="loading-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center;"><div class="spinner"></div><div style="margin-top: 10px;">Refreshing with genome: ' + selectedGenome + '</div></div>');
                
                let trackConfigs = [];
                let currentLocus = null;
                
                // If browser exists, try to preserve tracks and locus
                if (igvBrowser && igvBrowser.trackViews) {
                    try {
                        currentLocus = igvBrowser.currentLoci();
                        const currentTracks = [...igvBrowser.trackViews];
                        trackConfigs = currentTracks.map(tv => tv.track.config).filter(config => 
                            config && !config.isReference && config.type !== 'sequence'
                        );
                    } catch (e) {
                        console.log('Could not store current state:', e);
                    }
                }
                
                // Force full reload with selected genome
                igvBrowser = null;
                igvDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Loading genome: ' + selectedGenome + '</div>';
                
                // Initialize with the selected genome
                await initIGV(selectedGenome);
                
                // Wait for browser to be ready
                let attempts = 0;
                while ((!igvBrowser || !igvBrowser.genome) && attempts < 30) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                    attempts++;
                }
                
                if (igvBrowser && igvBrowser.genome) {
                    console.log('IGV refreshed with genome:', selectedGenome);
                    
                    // Check genome compatibility and show/hide warning
                    // First ensure genomeConfig is loaded
                    if (!genomeConfig) {
                        try {
                            const genomesResponse = await fetch('/api/genomes');
                            const genomes = await genomesResponse.json();
                            genomeConfig = genomes['danRer7'] || genomes[selectedGenome];
                        } catch (e) {
                            console.log('Could not fetch genome config for compatibility check');
                        }
                    }
                    
                    if (genomeConfig && genomeConfig.annotationURL) {
                        const isCompatible = checkGenomeAnnotationCompatibility(selectedGenome, genomeConfig);
                        
                        // Remove any existing warnings
                        const existingWarning = igvDiv.querySelector('.genome-warning');
                        if (existingWarning) existingWarning.remove();
                        
                        if (!isCompatible) {
                            const warningDiv = document.createElement('div');
                            warningDiv.className = 'genome-warning';
                            warningDiv.innerHTML = `
                                <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; margin: 10px 0; border-radius: 4px;">
                                    <strong>⚠️ Warning:</strong> Gene annotation track may not match the selected genome assembly (${selectedGenome}). 
                                    Annotation track will be hidden to prevent coordinate misalignment.
                                </div>
                            `;
                            igvDiv.appendChild(warningDiv);
                        }
                    }
                    
                    // Restore locus - prioritize stored variant coordinates
                    let locusToRestore = null;
                    if (igvBrowser && igvBrowser.currentVariant) {
                        locusToRestore = igvBrowser.currentVariant.locus;
                    } else if (currentLocus && currentLocus.length > 0) {
                        locusToRestore = currentLocus[0];
                    }

                    if (locusToRestore) {
                        try {
                            await igvBrowser.search(locusToRestore);
                            console.log('Restored locus:', locusToRestore);
                        } catch (e) {
                            console.log('Could not restore locus (may be incompatible with new genome):', e);
                        }
                    }
                    
                    // Check GFF compatibility and filter tracks accordingly
                    const isGffCompatible = genomeConfig && genomeConfig.annotationURL ? 
                        checkGenomeAnnotationCompatibility(selectedGenome, genomeConfig) : true;
                    
                    // Remove any existing warnings
                    const existingWarning = igvDiv.querySelector('.genome-warning');
                    if (existingWarning) existingWarning.remove();
                    
                    // Show warning if GFF is incompatible
                    if (genomeConfig && genomeConfig.annotationURL && !isGffCompatible) {
                        const warningDiv = document.createElement('div');
                        warningDiv.className = 'genome-warning';
                        warningDiv.innerHTML = `
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; margin: 10px 0; border-radius: 4px;">
                                <strong>⚠️ Warning:</strong> Custom GFF file is incompatible with ${selectedGenome}. GFF track hidden to prevent coordinate errors.
                            </div>
                        `;
                        igvDiv.appendChild(warningDiv);
                    }
                    
                    // Restore tracks, filtering out incompatible GFF
                    for (const trackConfig of trackConfigs) {
                        // Skip GFF tracks if incompatible
                        if (!isGffCompatible && trackConfig.name && 
                            (trackConfig.name.includes('GFF') || trackConfig.name.includes('Gene Annotations'))) {
                            console.log('Skipping incompatible GFF track:', trackConfig.name);
                            continue;
                        }
                        
                        try {
                            await igvBrowser.loadTrack(trackConfig);
                            console.log('Restored track:', trackConfig.name);
                        } catch (e) {
                            console.log('Could not restore track:', trackConfig.name, e);
                        }
                    }
                } else {
                    console.error('Failed to initialize IGV browser');
                }
                
            } catch (error) {
                console.error('Error during IGV refresh:', error);
                igvDiv.innerHTML = '<div style="padding: 20px; color: red;">Error refreshing IGV. Check console for details.</div>';
            } finally {
                // Clean up any loading indicators
                setTimeout(() => {
                    const overlay = igvDiv.querySelector('.loading-overlay');
                    const loading = igvDiv.querySelector('.loading');
                    if (overlay) overlay.remove();
                    if (loading) loading.remove();
                }, 1000);
            }
        }

        // Fit all tracks to optimal height
        async function fitIGVTracks() {
            if (!igvBrowser || !igvBrowser.trackViews) return;
            
            for (const trackView of igvBrowser.trackViews) {
                if (trackView.track.type === 'alignment') {
                    try {
                        // Method 1: Try to get the alignment container and count actual rendered rows
                        let visibleRows = 0;
                        
                        // Look for the track's viewport div
                        const viewport = trackView.viewports?.[0] || trackView.$viewport?.[0];
                        if (viewport) {
                            // Count rendered alignment rows in the DOM
                            const renderedAlignments = viewport.querySelectorAll('.alignment, .igv-alignment-row, [class*="alignment"]');
                            visibleRows = renderedAlignments.length;
                            console.log(`Found ${visibleRows} rendered alignments in DOM`);
                        }
                        
                        // Method 2: Check track's internal properties
                        if (visibleRows === 0) {
                            const trackProps = [
                                'alignmentRowCount',
                                'maxRows', 
                                'nRows',
                                'displayedAlignmentRows',
                                'visibleAlignmentCount'
                            ];
                            
                            for (const prop of trackProps) {
                                if (trackView.track[prop] && trackView.track[prop] > 0) {
                                    visibleRows = trackView.track[prop];
                                    console.log(`Using track.${prop}: ${visibleRows}`);
                                    break;
                                }
                            }
                        }
                        
                        // Method 3: Force track to recalculate by triggering a repaint first
                        if (visibleRows === 0) {
                            console.log('No visible rows found, triggering repaint...');
                            await trackView.repaintViews();
                            
                            // Wait a moment for repaint
                            await new Promise(resolve => setTimeout(resolve, 500));
                            
                            // Try counting again
                            const viewport = trackView.viewports?.[0] || trackView.$viewport?.[0];
                            if (viewport) {
                                const renderedAlignments = viewport.querySelectorAll('.alignment, .igv-alignment-row, [class*="alignment"]');
                                visibleRows = renderedAlignments.length;
                                console.log(`After repaint: ${visibleRows} alignments`);
                            }
                        }
                        
                        // Calculate optimal height
                        const rowHeight = 14; // Standard IGV row height
                        const headerHeight = 30;
                        const minHeight = 150;
                        const maxHeight = 800;
                        
                        let optimalHeight;
                        if (visibleRows > 0) {
                            optimalHeight = Math.max(minHeight, Math.min(maxHeight, (visibleRows * rowHeight) + headerHeight));
                            console.log(`Setting BAM track height to ${optimalHeight}px for ${visibleRows} rows`);
                        } else {
                            // Fallback: set to a reasonable default
                            optimalHeight = 300;
                            console.log('Could not determine row count, using fallback height');
                        }
                        
                        trackView.setTrackHeight(optimalHeight);
                        
                    } catch (error) {
                        console.error('Error fitting alignment track:', error);
                        trackView.setTrackHeight(300); // Safe fallback
                    }
                    
                } else if (trackView.track.type === 'annotation') {
                    // For annotation tracks, try to expand to show all features
                    try {
                        // Set to expanded mode
                        if (trackView.track.displayMode !== 'EXPANDED') {
                            trackView.track.displayMode = 'EXPANDED';
                        }
                        
                        // Set a reasonable height for annotations
                        trackView.setTrackHeight(150);
                        await trackView.repaintViews();
                        
                    } catch (error) {
                        console.error('Error fitting annotation track:', error);
                        trackView.setTrackHeight(120);
                    }
                }
            }
            
            // Force IGV to refresh after all changes
            setTimeout(() => {
                if (igvBrowser) {
                    igvBrowser.visibilityChange();
                }
            }, 200);
        }     

        // Reset tracks to default heights
        function resetIGVTracks() {
            if (!igvBrowser || !igvBrowser.trackViews) return;
            
            igvBrowser.trackViews.forEach(trackView => {
                if (trackView.track.type === 'alignment') {
                    // Reset BAM tracks only
                    trackView.setTrackHeight(250); // Default BAM height
                    
                    // Reset max rows if it was modified
                    if (trackView.track.maxRows) {
                        trackView.track.maxRows = 500; // IGV default
                    }
                    
                    console.log('Reset BAM track:', trackView.track.name);
                }
            });
        }      

        // Reinitialize IGV when genome changes
        document.getElementById('genomeSelect').addEventListener('change', function() {
            const selectedTab = document.querySelector('.tab.active');
            if (selectedTab && selectedTab.textContent.includes('IGV')) {
                igvBrowser = null;
                initIGV();
                
                // Show genome compatibility warning if needed
                if (genomeConfig && genomeConfig.annotationURL) {
                    const selectedGenome = this.value;
                    const isCompatible = checkGenomeAnnotationCompatibility(selectedGenome, genomeConfig);
                    
                    if (!isCompatible) {
                        const igvDiv = document.getElementById('igvDiv');
                        const existingWarning = igvDiv.querySelector('.genome-warning');
                        if (existingWarning) existingWarning.remove();
                        
                        const warningDiv = document.createElement('div');
                        warningDiv.className = 'genome-warning';
                        warningDiv.innerHTML = `
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; margin: 10px 0; border-radius: 4px;">
                                <strong>⚠️ Warning:</strong> Gene annotation track may not match the selected genome assembly (${selectedGenome}). 
                                Annotation track will be hidden to prevent coordinate misalignment.
                            </div>
                        `;
                        igvDiv.appendChild(warningDiv);
                    } else {
                        // Remove warning if genome is now compatible
                        const existingWarning = igvDiv.querySelector('.genome-warning');
                        if (existingWarning) existingWarning.remove();
                    }
                }
            }
        });       
        
        function populateFilters() {
            // Populate chromosome filter with numeric sorting
            const chromosomes = [...new Set(variantData.map(v => v.chromosome))];
            
            // Smart chromosome sorting (numeric for numbers, lexicographic for others)
            chromosomes.sort((a, b) => {
                // Remove 'chr' prefix if present for comparison
                const aNum = a.toString().replace(/^chr/i, '');
                const bNum = b.toString().replace(/^chr/i, '');
                
                // Check if both are numeric
                const aIsNum = !isNaN(aNum) && !isNaN(parseFloat(aNum));
                const bIsNum = !isNaN(bNum) && !isNaN(parseFloat(bNum));
                
                if (aIsNum && bIsNum) {
                    // Both numeric - sort numerically
                    return parseFloat(aNum) - parseFloat(bNum);
                } else if (aIsNum) {
                    // a is numeric, b is not - a comes first
                    return -1;
                } else if (bIsNum) {
                    // b is numeric, a is not - b comes first
                    return 1;
                } else {
                    // Both non-numeric - sort lexicographically
                    return a.localeCompare(b);
                }
            });
            
            const chrSelect = document.getElementById('chromosomeFilter');
            chrSelect.innerHTML = '<option value="">All Chromosomes</option>';
            chromosomes.forEach(chr => {
                chrSelect.innerHTML += `<option value="${chr}">${chr}</option>`;
            });
        }
        
        function applyFilters() {
            filteredData = variantData.filter(variant => {
                const chrFilter = document.getElementById('chromosomeFilter').value;
                const impactFilter = document.getElementById('impactFilter').value;
                const geneFilter = document.getElementById('geneFilter').value.toLowerCase();
                const depthFilter = parseInt(document.getElementById('depthFilter').value) || 0;
                
                return (!chrFilter || variant.chromosome === chrFilter) &&
                       (!impactFilter || variant.vep_impact === impactFilter || variant.snpeff_impact === impactFilter) &&
                       (!geneFilter || 
                        variant.vep_gene.toLowerCase().includes(geneFilter) || 
                        variant.snpeff_gene.toLowerCase().includes(geneFilter)) &&
                       (variant.depth >= depthFilter);
            });
            
            updateTable();
            updateStats();
        }
        
        function clearFilters() {
            document.getElementById('chromosomeFilter').value = '';
            document.getElementById('impactFilter').value = '';
            document.getElementById('geneFilter').value = '';
            document.getElementById('depthFilter').value = '';
            filteredData = [...variantData];
            updateTable();
            updateStats();
        }
        
        function updateTable() {
            const tbody = document.getElementById('tableBody');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="loading">No variants match current filters</td></tr>';
                return;
            }
            
            tbody.innerHTML = filteredData.map(variant => {
                const vepImpactClass = `impact-${(variant.vep_impact || '').toLowerCase()}`;
                const snpeffImpactClass = `impact-${(variant.snpeff_impact || '').toLowerCase()}`;
                return `
                    <tr>
                        <td class="frozen-col"><strong>${variant.variant_id}</strong></td>
                        <td class="frozen-col">
                            <button class="btn" style="font-size: 0.7em; padding: 4px 8px; margin-right: 2px;" onclick="viewInIGV('${variant.chromosome}', ${variant.position}, '${variant.sample_id}')">IGV</button>
                            <button class="btn" style="font-size: 0.7em; padding: 4px 8px;" onclick="viewInGosling('${variant.variant_id}', '${variant.chromosome}', ${variant.position})">Gosling</button>
                        </td>
                        <td>${variant.genotype}</td>
                        <td>${variant.depth}</td>
                        <td>${variant.allele_freq ? variant.allele_freq.toFixed(2) : '-'}</td>
                        <td class="vep-col">${variant.vep_gene || '-'}</td>
                        <td class="snpeff-col">${variant.snpeff_gene || '-'}</td>
                        <td class="vep-col">
                            ${variant.vep_impact ? `<span style="background-color: ${variant.vep_impact_color}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75em;">${variant.vep_impact}</span>` : '-'}
                        </td>
                        <td class="snpeff-col">
                            ${variant.snpeff_impact ? `<span style="background-color: ${variant.snpeff_impact_color}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75em;">${variant.snpeff_impact}</span>` : '-'}
                        </td>
                        <td class="vep-col">${variant.vep_consequence || '-'}</td>
                        <td class="snpeff-col">${variant.snpeff_effect || '-'}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateStats() {
            const stats = document.getElementById('stats');
            const total = filteredData.length;
            const vepHighImpact = filteredData.filter(v => v.vep_impact === 'HIGH').length;
            const snpeffHighImpact = filteredData.filter(v => v.snpeff_impact === 'HIGH').length;
            const avgDepth = filteredData.reduce((sum, v) => sum + v.depth, 0) / total || 0;
            const uniqueVepGenes = new Set(filteredData.map(v => v.vep_gene).filter(g => g)).size;
            const uniqueSnpeffGenes = new Set(filteredData.map(v => v.snpeff_gene).filter(g => g)).size;
            
            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">Total Variants</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${vepHighImpact}</div>
                    <div class="stat-label">VEP High Impact</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${snpeffHighImpact}</div>
                    <div class="stat-label">SnpEff High Impact</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgDepth.toFixed(1)}</div>
                    <div class="stat-label">Avg Depth</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${uniqueVepGenes}</div>
                    <div class="stat-label">VEP Genes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${uniqueSnpeffGenes}</div>
                    <div class="stat-label">SnpEff Genes</div>
                </div>
            `;
        }

        function setFilterControlsEnabled(enabled) {
            // document.getElementById('genomeSelect').disabled = !enabled;
            document.getElementById('chromosomeFilter').disabled = !enabled;
            document.getElementById('impactFilter').disabled = !enabled;
            document.getElementById('geneFilter').disabled = !enabled;
            document.getElementById('depthFilter').disabled = !enabled;
            document.querySelector('button[onclick="applyFilters()"]').disabled = !enabled;
            document.querySelector('button[onclick="clearFilters()"]').disabled = !enabled;
        }

        function showTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            // Add active class to selected tab and show content
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).style.display = 'block';

            // Hide IGV info when not on IGV tab
            if (tabName !== 'igv') {
                document.getElementById('igv-info').style.display = 'none';
            }

            // Enable filters only for the table tab
            setFilterControlsEnabled(tabName === 'table');
        }     

        function initIGV(genome) {
            const selectedGenome = genome || document.getElementById('genomeSelect').value || 'danRer7';

            // Always clear the IGV container before (re)creating the browser
            const igvDiv = document.getElementById('igvDiv');
            igvDiv.innerHTML = '';

            // If custom genome, fetch config and use fasta/index URLs
            if (selectedGenome === 'danRer7') {
                fetch('/api/genomes')
                    .then(res => res.json())
                    .then(genomes => {
                        genomeConfig = genomes['danRer7'];
                        if (!genomeConfig) {
                            igvDiv.innerHTML = '<div style="color:red;padding:20px;">Custom genome config not found.</div>';
                            return;
                        }
                        const options = {
                            genome: {
                                fastaURL: genomeConfig.fastaURL,
                                indexURL: genomeConfig.indexURL,
                                chromosomeOrder: genomeConfig.chromosomeOrder.split(','),
                            },
                            locus: 'chr1:1',
                            tracks: [],
                            showNavigation: true,
                            showRuler: true,
                            showCenterGuide: true,
                            trackHeight: 300
                        };
                        igv.createBrowser(igvDiv, options)
                            .then(function (browser) {
                                igvBrowser = browser;
                                igvBrowser.genomeName = selectedGenome;
                                console.log('IGV browser initialized with custom genome:', selectedGenome);
                            })
                            .catch(function(error) {
                                console.error('Error initializing IGV:', error);
                                igvDiv.innerHTML = '<div style="padding: 20px; color: red;">Error loading IGV browser. Check console for details.</div>';
                            });
                    })
                    .catch(() => {
                        igvDiv.innerHTML = '<div style="color:red;padding:20px;">Failed to fetch custom genome config.</div>';
                    });
                return;
            }

            const options = {
                genome: selectedGenome,
                locus: selectedGenome.startsWith('danRer') ? 'chr1:1' : 'chr1:2',
                tracks: [],
                showNavigation: true,
                showRuler: true,
                showCenterGuide: true,
                trackHeight: 300
            };

            igv.createBrowser(igvDiv, options)
                .then(function (browser) {
                    igvBrowser = browser;
                    igvBrowser.genomeName = selectedGenome; // Track genome in browser object
                    console.log('IGV browser initialized with genome:', selectedGenome);
                })
                .catch(function(error) {
                    console.error('Error initializing IGV:', error);
                    igvDiv.innerHTML = '<div style="padding: 20px; color: red;">Error loading IGV browser. Check console for details.</div>';
                });
        }

        async function viewInIGV(chromosome, position, sampleId) {
            showTab('igv');

            const selectedGenome = document.getElementById('genomeSelect').value || 'danRer9';

            // Only re-init IGV if genome changed or browser not initialized
            if (!igvBrowser || !igvBrowser.genomeName || igvBrowser.genomeName !== selectedGenome) {
                await initIGV(selectedGenome);
            }

            // Show loading spinner (optional, but don't clear IGV container)
            document.getElementById('igvDiv').insertAdjacentHTML('beforeend', '<div class="loading"><div class="spinner"></div>Loading IGV...</div>');

            // Wait for IGV to be ready with the correct genome
            let tries = 0;
            while ((!igvBrowser || !igvBrowser.genomeName || igvBrowser.genomeName !== selectedGenome) && tries < 20) {
                await new Promise(res => setTimeout(res, 300));
                tries++;
            }
            if (!igvBrowser || igvBrowser.genomeName !== selectedGenome) {
                document.getElementById('igvDiv').innerHTML = `<div style="color:red;padding:20px;">
                    IGV browser failed to initialize for genome <b>${selectedGenome}</b>.
                </div>`;
                return;
            }

            // Find the correct variant
            const variant = variantData.find(v =>
                v.chromosome === chromosome &&
                v.position === position &&
                v.sample_id === sampleId
            );
            if (!variant) {
                document.getElementById('igvDiv').innerHTML = `<div style="color:red;padding:20px;">
                    Variant not found for sample: ${sampleId}, ${chromosome}:${position}
                </div>`;
                return;
            }

            // Navigate to locus
            const windowSize = 20;
            const locus = `${chromosome}:${position - windowSize}-${position + windowSize}`;
            await igvBrowser.search(locus);

            // Remove all tracks before loading new ones
            await igvBrowser.removeAllTracks();

            // Store current variant for refresh functionality
            igvBrowser.currentVariant = {
                variant_id: variant.variant_id,
                chromosome: chromosome,
                position: position,
                locus: `${chromosome}:${position - windowSize}-${position + windowSize}`,
                gene_info: `VEP: ${variant.vep_gene || 'N/A'} | SnpEff: ${variant.snpeff_gene || 'N/A'}`
            };

            // Update info display
            document.getElementById('igv-variant-id').textContent = variant.variant_id;
            document.getElementById('igv-coordinates').textContent = `${chromosome}:${position}`;
            document.getElementById('igv-gene-info').textContent = igvBrowser.currentVariant.gene_info;
            document.getElementById('igv-info').style.display = 'block';

            // Prepare tracks
            const tracks = [];

            // Validate custom GFF/annotation track compatibility
            if (genomeConfig && genomeConfig.annotationURL) {
                const isGenomeCompatible = checkGenomeAnnotationCompatibility(selectedGenome, genomeConfig);
                
                if (isGenomeCompatible) {
                    tracks.push({
                        name: 'Custom Gene Annotations (GFF)',
                        type: 'annotation',
                        format: genomeConfig.annotationFormat,
                        url: genomeConfig.annotationURL,
                        displayMode: 'EXPANDED',
                        height: 100
                    });
                } else {
                    // Show warning about custom GFF file
                    const warningDiv = document.createElement('div');
                    warningDiv.innerHTML = `
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; margin: 10px 0; border-radius: 4px;">
                            <strong>⚠️ Warning:</strong> Custom GFF annotation file may not match the selected genome assembly (${selectedGenome}). 
                            Custom annotations hidden to prevent coordinate misalignment. RefSeq annotations (if available) will still load.
                        </div>
                    `;
                    document.getElementById('igvDiv').appendChild(warningDiv);
                    
                    console.warn(`Custom GFF track skipped - genome mismatch. Selected: ${selectedGenome}, GFF: ${genomeConfig.genome || 'unknown'}`);
                }
            }
            tracks.push({
                type: 'annotation',
                format: 'bed',
                name: 'Variant Position',
                features: [{
                    chr: chromosome,
                    start: position - 1,
                    end: position,
                    name: `${variant.variant_id}`,
                    color: '#FF0000',
                    height: 40
                }]
            });          
            if (variant.mutant_bam_subset_path) {
                const samplePath = '/data/' + variant.mutant_bam_subset_path;
                tracks.push({
                    type: 'alignment',
                    format: 'bam',
                    url: samplePath,
                    indexURL: samplePath + '.bai',
                    name: `${sampleId} (Sample)`,
                    displayMode: 'EXPANDED',
                    height: 250,
                    colorBy: 'strand',
                    showSoftClips: true,
                    viewAsPairs: false,
                    maxRows: 500,
                    color: '#FF6B6B'
                });
            }              
            if (variant.reference_bam_paths) {
                const refPaths = variant.reference_bam_paths.split('|');
                refPaths.forEach((refPath, index) => {
                    if (refPath && refPath.trim()) {
                        const cleanPath = '/data/' + refPath.trim();
                        tracks.push({
                            type: 'alignment',
                            format: 'bam',
                            url: cleanPath,
                            indexURL: cleanPath + '.bai',
                            name: `Reference ${index + 1}`,
                            displayMode: 'EXPANDED',
                            height: 200,
                            colorBy: 'strand',
                            showSoftClips: true,
                            viewAsPairs: false,
                            maxRows: 500
                        });
                    }
                });
            }

            // Load tracks sequentially
            for (const track of tracks) {
                try {
                    await igvBrowser.loadTrack(track);
                } catch (error) {
                    if (track.type === 'alignment' && track.indexURL) {
                        const trackWithoutIndex = { ...track };
                        delete trackWithoutIndex.indexURL;
                        try {
                            await igvBrowser.loadTrack(trackWithoutIndex);
                        } catch (e) {}
                    }
                }
            }

            // Remove spinner
            const spinner = document.getElementById('igvDiv').querySelector('.loading');
            if (spinner) spinner.remove();
        }        

        function viewInGosling(variantId, chromosome, position) {
            showTab('gosling');
            createGoslingPlot(variantId, chromosome, position);
        }
        
        function createGoslingPlot(variantId, chromosome, position) {
            const variant = variantData.find(v => v.variant_id === variantId);
            
            document.getElementById('goslingDiv').innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <h3>Gosling Visualization for ${variantId}</h3>
                    <p>Position: ${chromosome}:${position}</p>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <p><strong>VEP:</strong> ${variant.vep_gene || 'N/A'} | ${variant.vep_impact || 'N/A'} | ${variant.vep_consequence || 'N/A'}</p>
                        <p><strong>SnpEff:</strong> ${variant.snpeff_gene || 'N/A'} | ${variant.snpeff_impact || 'N/A'} | ${variant.snpeff_effect || 'N/A'}</p>
                        <p><strong>Mutant BAM:</strong> ${variant.mutant_bam_subset_path || 'N/A'}</p>
                        <p><strong>Reference BAMs:</strong> ${variant.reference_bam_paths || 'N/A'}</p>
                    </div>
                    <p><em>Gosling visualization would render here with proper BAM data integration</em></p>
                </div>
            `;
        }
    </script>
</body>
</html>