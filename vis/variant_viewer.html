<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src-elem 'self' 'unsafe-inline'; worker-src 'self' blob:; connect-src 'self' *; img-src 'self' data: *">
    <title>EMUMADZ Variant Analysis Viewer</title>
    <script src="/api/igv-proxy/igv.min.js"></script>
    <link rel="stylesheet" href="/api/igv-proxy/igv.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: auto;
            resize: both;
        }
        
        .header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: 2px;
        }
        
        .controls {
            padding: 25px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }
        
        .control-group input, .control-group select {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }
        
        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 10px 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.3);
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: white;
            color: #495057;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 25px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        th, td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            white-space: nowrap;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.8rem;
        }
        
        .impact-high { background-color: rgba(255, 0, 0, 0.1); }
        .impact-moderate { background-color: rgba(255, 140, 0, 0.1); }
        .impact-low { background-color: rgba(50, 205, 50, 0.1); }
        .impact-modifier { background-color: rgba(135, 206, 235, 0.1); }

        .igv-container {
            width: 100%;
            min-height: 400px;
            /* height: 50vh; Responsive: 50% of viewport height */
            /* max-height: 80vh; */
            /* border: 1px solid #dee2e6; */
            border-radius: 8px;
            margin-top: 20px;
            box-sizing: border-box;
            /* Remove resize and overflow for full width */
        }        

        .gosling-container {
            height: 500px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .annotation-group {
            border-right: 2px solid #e9ecef;
            padding-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>EMUMADZ Variant Analysis Viewer</h1>
            <button class="btn" id="backToFilesBtn" style="display:none; margin-top: 10px;" onclick="showFileList()">← Back to File Landing Page</button>
        </div>

        <div id="file-list-view">
            <h2 style="text-align:center; margin-top:20px;">File Landing Page</h2>
            <div class="table-container">
                <table id="fileListTable">
                    <thead>
                        <tr>
                            <th>Sample Name</th>
                            <th>Size</th>
                            <th>Modified</th>
                            <th>Action</th>
                            <th>File Name</th>
                        </tr>
                    </thead>
                    <tbody id="fileListBody">
                        <tr><td colspan="5" class="loading">Loading available files...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
                
        <div id="variant-view" style="display: none;">
            <div class="controls">
                <!-- <button class="btn" onclick="showFileList()" style="margin-right: 10px;">← Back to Files</button> -->
                <span id="currentFileName" style="font-weight: bold; margin-right: 20px;"></span>
                
                <div class="control-group">
                    <label>Reference Genome:</label>
                    <select id="genomeSelect">
                        <option value="danRer7">Zebrafish (Zv9)</option>
                        <option value="danRer10">Zebrafish (danRer10)</option>
                        <option value="danRer11">Zebrafish (danRer11)</option>                        
                        <option value="hg38">Human (hg38)</option>
                        <option value="hg19">Human (hg19)</option>
                        <option value="mm10">Mouse (mm10)</option>
                        <option value="dm6">Drosophila (dm6)</option>
                        <option value="ce11">C. elegans (ce11)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Chromosome:</label>
                    <select id="chromosomeFilter">
                        <option value="">All Chromosomes</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Impact:</label>
                    <select id="impactFilter">
                        <option value="">All Impacts</option>
                        <option value="HIGH">High</option>
                        <option value="MODERATE">Moderate</option>
                        <option value="LOW">Low</option>
                        <option value="MODIFIER">Modifier</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Gene:</label>
                    <input type="text" id="geneFilter" placeholder="Search genes...">
                </div>
                
                <div class="control-group">
                    <label>Min Depth:</label>
                    <input type="number" id="depthFilter" min="0" placeholder="0">
                </div>
                
                <button class="btn" onclick="applyFilters()">Apply Filters</button>
                <button class="btn" onclick="clearFilters()">Clear</button>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('table')">Variant Table</button>
                <button class="tab" onclick="showTab('igv')">IGV Browser</button>
                <button class="tab" onclick="showTab('gosling')">Gosling Plots</button>
            </div>
            
            <div id="table-tab" class="tab-content active">
                <div class="stats" id="stats"></div>
                <div class="table-container">
                    <table id="variantTable">
                        <thead>
                            <tr>
                                <th>Variant ID</th>
                                <th>Sample</th>
                                <th>Genotype</th>
                                <th>Depth</th>
                                <th>AF</th>
                                <th class="annotation-group">VEP Gene</th>
                                <th class="annotation-group">VEP Impact</th>
                                <th class="annotation-group">VEP Consequence</th>
                                <th>SnpEff Gene</th>
                                <th>SnpEff Impact</th>
                                <th>SnpEff Effect</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr><td colspan="12" class="loading">Load a JSON file to view variants</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="igv-tab" class="tab-content">
                <div class="igv-container" id="igvDiv"></div>
            </div>
            
            <div id="gosling-tab" class="tab-content">
                <div class="gosling-container" id="goslingDiv"></div>
            </div>
        </div>
    </div>

    <script>
        let variantData = [];
        let filteredData = [];
        let igvBrowser = null;
        let fileList = [];
        let genomeConfig = null;
        
        // Auto-load file list on page load
        window.addEventListener('load', loadFileList);
        
        // Load file list from server
        function loadFileList() {
            fetch('/api/files')
                .then(response => response.json())
                .then(files => {
                    fileList = files;
                    displayFileList();
                })
                .catch(error => {
                    console.error('Error loading file list:', error);
                    document.getElementById('fileListBody').innerHTML = 
                        '<tr><td colspan="5" style="color: red;">Error loading files. Check server connection.</td></tr>';
                });
        }
        
        function displayFileList() {
            const tbody = document.getElementById('fileListBody');
            
            if (fileList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">No JSON files found in data directory</td></tr>';
                return;
            }
            
            tbody.innerHTML = fileList.map(file => {
                // Extract sample name from filename (remove .json extension and clean up)
                const sampleName = file.name.replace('.json', '').replace(/[_-]/g, ' ');
                
                return `
                    <tr>
                        <td><strong>${sampleName}</strong></td>
                        <td>${formatFileSize(file.size || 0)}</td>
                        <td>${file.modified ? new Date(file.modified).toLocaleString() : '-'}</td>
                        <td>
                            <button class="btn" style="font-size: 0.8em; padding: 6px 12px;" onclick="loadVariantFile('${file.name}')">Load</button>
                        </td>
                        <td>${file.name}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        function loadVariantFile(filename) {
            fetch(`/data/${filename}`)
                .then(response => response.json())
                .then(data => {
                    variantData = data;
                    filteredData = [...variantData];
                    document.getElementById('currentFileName').textContent = filename;
                    showVariantView();
                    populateFilters();
                    updateTable();
                    updateStats();
                })
                .catch(error => {
                    alert('Error loading file: ' + error.message);
                });
        }
        
        function showFileList() {
            document.getElementById('file-list-view').style.display = 'block';
            document.getElementById('variant-view').style.display = 'none';
            document.getElementById('backToFilesBtn').style.display = 'none';
        }

        function showVariantView() {
            document.getElementById('file-list-view').style.display = 'none';
            document.getElementById('variant-view').style.display = 'block';
            document.getElementById('backToFilesBtn').style.display = 'inline-block';
        }
        // Reinitialize IGV when genome changes
        document.getElementById('genomeSelect').addEventListener('change', function() {
            const selectedTab = document.querySelector('.tab.active');
            if (selectedTab && selectedTab.textContent.includes('IGV')) {
                igvBrowser = null;
                initIGV();
            }
        });        
        
        function populateFilters() {
            // Populate chromosome filter
            const chromosomes = [...new Set(variantData.map(v => v.chromosome))].sort();
            const chrSelect = document.getElementById('chromosomeFilter');
            chrSelect.innerHTML = '<option value="">All Chromosomes</option>';
            chromosomes.forEach(chr => {
                chrSelect.innerHTML += `<option value="${chr}">${chr}</option>`;
            });
        }
        
        function applyFilters() {
            filteredData = variantData.filter(variant => {
                const chrFilter = document.getElementById('chromosomeFilter').value;
                const impactFilter = document.getElementById('impactFilter').value;
                const geneFilter = document.getElementById('geneFilter').value.toLowerCase();
                const depthFilter = parseInt(document.getElementById('depthFilter').value) || 0;
                
                return (!chrFilter || variant.chromosome === chrFilter) &&
                       (!impactFilter || variant.vep_impact === impactFilter || variant.snpeff_impact === impactFilter) &&
                       (!geneFilter || 
                        variant.vep_gene.toLowerCase().includes(geneFilter) || 
                        variant.snpeff_gene.toLowerCase().includes(geneFilter)) &&
                       (variant.depth >= depthFilter);
            });
            
            updateTable();
            updateStats();
        }
        
        function clearFilters() {
            document.getElementById('chromosomeFilter').value = '';
            document.getElementById('impactFilter').value = '';
            document.getElementById('geneFilter').value = '';
            document.getElementById('depthFilter').value = '';
            filteredData = [...variantData];
            updateTable();
            updateStats();
        }
        
        function updateTable() {
            const tbody = document.getElementById('tableBody');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="loading">No variants match current filters</td></tr>';
                return;
            }
            
            tbody.innerHTML = filteredData.map(variant => {
                const vepImpactClass = `impact-${(variant.vep_impact || '').toLowerCase()}`;
                const snpeffImpactClass = `impact-${(variant.snpeff_impact || '').toLowerCase()}`;
                return `
                    <tr>
                        <td><strong>${variant.variant_id}</strong></td>
                        <td>${variant.sample_id}</td>
                        <td>${variant.genotype}</td>
                        <td>${variant.depth}</td>
                        <td>${variant.allele_freq ? variant.allele_freq.toFixed(2) : '-'}</td>
                        <td class="annotation-group">${variant.vep_gene || '-'}</td>
                        <td class="annotation-group">
                            ${variant.vep_impact ? `<span style="background-color: ${variant.vep_impact_color}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75em;">${variant.vep_impact}</span>` : '-'}
                        </td>
                        <td class="annotation-group">${variant.vep_consequence || '-'}</td>
                        <td>${variant.snpeff_gene || '-'}</td>
                        <td>
                            ${variant.snpeff_impact ? `<span style="background-color: ${variant.snpeff_impact_color}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75em;">${variant.snpeff_impact}</span>` : '-'}
                        </td>
                        <td>${variant.snpeff_effect || '-'}</td>
                        <td>
                            <button class="btn" style="font-size: 0.7em; padding: 4px 8px;" onclick="viewInIGV('${variant.chromosome}', ${variant.position}, '${variant.sample_id}')">IGV</button>
                            <button class="btn" style="font-size: 0.7em; padding: 4px 8px;" onclick="viewInGosling('${variant.variant_id}', '${variant.chromosome}', ${variant.position})">Plot</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateStats() {
            const stats = document.getElementById('stats');
            const total = filteredData.length;
            const vepHighImpact = filteredData.filter(v => v.vep_impact === 'HIGH').length;
            const snpeffHighImpact = filteredData.filter(v => v.snpeff_impact === 'HIGH').length;
            const avgDepth = filteredData.reduce((sum, v) => sum + v.depth, 0) / total || 0;
            const uniqueVepGenes = new Set(filteredData.map(v => v.vep_gene).filter(g => g)).size;
            const uniqueSnpeffGenes = new Set(filteredData.map(v => v.snpeff_gene).filter(g => g)).size;
            
            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">Total Variants</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${vepHighImpact}</div>
                    <div class="stat-label">VEP High Impact</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${snpeffHighImpact}</div>
                    <div class="stat-label">SnpEff High Impact</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgDepth.toFixed(1)}</div>
                    <div class="stat-label">Avg Depth</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${uniqueVepGenes}</div>
                    <div class="stat-label">VEP Genes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${uniqueSnpeffGenes}</div>
                    <div class="stat-label">SnpEff Genes</div>
                </div>
            `;
        }

        function setFilterControlsEnabled(enabled) {
            document.getElementById('genomeSelect').disabled = !enabled;
            document.getElementById('chromosomeFilter').disabled = !enabled;
            document.getElementById('impactFilter').disabled = !enabled;
            document.getElementById('geneFilter').disabled = !enabled;
            document.getElementById('depthFilter').disabled = !enabled;
            document.querySelector('button[onclick="applyFilters()"]').disabled = !enabled;
            document.querySelector('button[onclick="clearFilters()"]').disabled = !enabled;
        }

        function showTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            // Add active class to selected tab and show content
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).style.display = 'block';

            // Enable filters only for the table tab
            setFilterControlsEnabled(tabName === 'table');
        }     

        function initIGV(genome) {
            const selectedGenome = genome || document.getElementById('genomeSelect').value || 'danRer7';

            // Always clear the IGV container before (re)creating the browser
            const igvDiv = document.getElementById('igvDiv');
            igvDiv.innerHTML = '';

            // If custom genome, fetch config and use fasta/index URLs
            if (selectedGenome === 'danRer7') {
                fetch('/api/genomes')
                    .then(res => res.json())
                    .then(genomes => {
                        genomeConfig = genomes['danRer7'];
                        if (!genomeConfig) {
                            igvDiv.innerHTML = '<div style="color:red;padding:20px;">Custom genome config not found.</div>';
                            return;
                        }
                        const options = {
                            genome: {
                                fastaURL: genomeConfig.fastaURL,
                                indexURL: genomeConfig.indexURL,
                                chromosomeOrder: genomeConfig.chromosomeOrder.split(','),
                            },
                            locus: 'chr1:1',
                            tracks: [],
                            showNavigation: true,
                            showRuler: true,
                            showCenterGuide: true,
                            trackHeight: 300
                        };
                        igv.createBrowser(igvDiv, options)
                            .then(function (browser) {
                                igvBrowser = browser;
                                igvBrowser.genomeName = selectedGenome;
                                console.log('IGV browser initialized with custom genome:', selectedGenome);
                            })
                            .catch(function(error) {
                                console.error('Error initializing IGV:', error);
                                igvDiv.innerHTML = '<div style="padding: 20px; color: red;">Error loading IGV browser. Check console for details.</div>';
                            });
                    })
                    .catch(() => {
                        igvDiv.innerHTML = '<div style="color:red;padding:20px;">Failed to fetch custom genome config.</div>';
                    });
                return;
            }

            const options = {
                genome: selectedGenome,
                locus: selectedGenome.startsWith('danRer') ? 'chr1:1' : 'chr1:2',
                tracks: [],
                showNavigation: true,
                showRuler: true,
                showCenterGuide: true,
                trackHeight: 300
            };

            igv.createBrowser(igvDiv, options)
                .then(function (browser) {
                    igvBrowser = browser;
                    igvBrowser.genomeName = selectedGenome; // Track genome in browser object
                    console.log('IGV browser initialized with genome:', selectedGenome);
                })
                .catch(function(error) {
                    console.error('Error initializing IGV:', error);
                    igvDiv.innerHTML = '<div style="padding: 20px; color: red;">Error loading IGV browser. Check console for details.</div>';
                });
        }

        async function viewInIGV(chromosome, position, sampleId) {
            showTab('igv');

            const selectedGenome = document.getElementById('genomeSelect').value || 'danRer9';

            // Only re-init IGV if genome changed or browser not initialized
            if (!igvBrowser || !igvBrowser.genomeName || igvBrowser.genomeName !== selectedGenome) {
                await initIGV(selectedGenome);
            }

            // Show loading spinner (optional, but don't clear IGV container)
            document.getElementById('igvDiv').insertAdjacentHTML('beforeend', '<div class="loading"><div class="spinner"></div>Loading IGV...</div>');

            // Wait for IGV to be ready with the correct genome
            let tries = 0;
            while ((!igvBrowser || !igvBrowser.genomeName || igvBrowser.genomeName !== selectedGenome) && tries < 20) {
                await new Promise(res => setTimeout(res, 300));
                tries++;
            }
            if (!igvBrowser || igvBrowser.genomeName !== selectedGenome) {
                document.getElementById('igvDiv').innerHTML = `<div style="color:red;padding:20px;">
                    IGV browser failed to initialize for genome <b>${selectedGenome}</b>.
                </div>`;
                return;
            }

            // Find the correct variant
            const variant = variantData.find(v =>
                v.chromosome === chromosome &&
                v.position === position &&
                v.sample_id === sampleId
            );
            if (!variant) {
                document.getElementById('igvDiv').innerHTML = `<div style="color:red;padding:20px;">
                    Variant not found for sample: ${sampleId}, ${chromosome}:${position}
                </div>`;
                return;
            }

            // Navigate to locus
            const windowSize = 20;
            const locus = `${chromosome}:${position - windowSize}-${position + windowSize}`;
            await igvBrowser.search(locus);

            // Remove all tracks before loading new ones
            await igvBrowser.removeAllTracks();

            // Prepare tracks
            const tracks = [];
            if (genomeConfig.annotationURL) {
                tracks.push({
                    name: 'Gene Annotations',
                    type: 'annotation',
                    format: genomeConfig.annotationFormat,
                    url: genomeConfig.annotationURL,
                    displayMode: 'EXPANDED',
                    height: 100
                });
            }
            tracks.push({
                type: 'annotation',
                format: 'bed',
                name: 'Variant Position',
                features: [{
                    chr: chromosome,
                    start: position - 1,
                    end: position,
                    name: `${variant.variant_id}`,
                    color: '#FF0000',
                    height: 40
                }]
            });          
            if (variant.mutant_bam_subset_path) {
                const samplePath = '/data/' + variant.mutant_bam_subset_path;
                tracks.push({
                    type: 'alignment',
                    format: 'bam',
                    url: samplePath,
                    indexURL: samplePath + '.bai',
                    name: `${sampleId} (Sample)`,
                    displayMode: 'EXPANDED',
                    height: 250,
                    colorBy: 'strand',
                    showSoftClips: true,
                    viewAsPairs: false,
                    maxRows: 500,
                    color: '#FF6B6B'
                });
            }              
            if (variant.reference_bam_paths) {
                const refPaths = variant.reference_bam_paths.split('|');
                refPaths.forEach((refPath, index) => {
                    if (refPath && refPath.trim()) {
                        const cleanPath = '/data/' + refPath.trim();
                        tracks.push({
                            type: 'alignment',
                            format: 'bam',
                            url: cleanPath,
                            indexURL: cleanPath + '.bai',
                            name: `Reference ${index + 1}`,
                            displayMode: 'EXPANDED',
                            height: 200,
                            colorBy: 'strand',
                            showSoftClips: true,
                            viewAsPairs: false,
                            maxRows: 500
                        });
                    }
                });
            }

            // Load tracks sequentially
            for (const track of tracks) {
                try {
                    await igvBrowser.loadTrack(track);
                } catch (error) {
                    if (track.type === 'alignment' && track.indexURL) {
                        const trackWithoutIndex = { ...track };
                        delete trackWithoutIndex.indexURL;
                        try {
                            await igvBrowser.loadTrack(trackWithoutIndex);
                        } catch (e) {}
                    }
                }
            }

            // Remove spinner
            const spinner = document.getElementById('igvDiv').querySelector('.loading');
            if (spinner) spinner.remove();
        }        

        function viewInGosling(variantId, chromosome, position) {
            showTab('gosling');
            createGoslingPlot(variantId, chromosome, position);
        }
        
        function createGoslingPlot(variantId, chromosome, position) {
            const variant = variantData.find(v => v.variant_id === variantId);
            
            document.getElementById('goslingDiv').innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <h3>Gosling Visualization for ${variantId}</h3>
                    <p>Position: ${chromosome}:${position}</p>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <p><strong>VEP:</strong> ${variant.vep_gene || 'N/A'} | ${variant.vep_impact || 'N/A'} | ${variant.vep_consequence || 'N/A'}</p>
                        <p><strong>SnpEff:</strong> ${variant.snpeff_gene || 'N/A'} | ${variant.snpeff_impact || 'N/A'} | ${variant.snpeff_effect || 'N/A'}</p>
                        <p><strong>Mutant BAM:</strong> ${variant.mutant_bam_subset_path || 'N/A'}</p>
                        <p><strong>Reference BAMs:</strong> ${variant.reference_bam_paths || 'N/A'}</p>
                    </div>
                    <p><em>Gosling visualization would render here with proper BAM data integration</em></p>
                </div>
            `;
        }
    </script>
</body>
</html>