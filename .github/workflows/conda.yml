name: Build and Upload Conda Package

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: ">=3.12"
        channels: conda-forge,bioconda,defaults
        channel-priority: strict
    
    - name: Install conda-build and anaconda-client
      shell: bash -l {0}
      run: |
        conda install -y conda-build anaconda-client
    
    - name: Build conda package
      shell: bash -l {0}
      run: |
        conda build .
    
    - name: Upload to Anaconda
      shell: bash -l {0}
      env:
        ANACONDA_USERNAME: ${{ secrets.ANACONDA_USERNAME }}      
        ANACONDA_PASSWORD: ${{ secrets.ANACONDA_PASSWORD }}
      run: |
        anaconda -t $ANACONDA_PASSWORD upload -u $ANACONDA_USERNAME $(conda build . --output)