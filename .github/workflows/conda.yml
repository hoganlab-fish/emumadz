name: Build and Upload Conda Package

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: "3.9"
        channels: conda-forge,bioconda,defaults
        channel-priority: strict
    
    - name: Configure conda
      shell: bash -l {0}
      run: |
        conda config --set solver libmamba
        conda config --set anaconda_upload no
        echo "verify: False" >> ~/.condarc

    - name: Install conda-build
      shell: bash -l {0}
      run: |
        conda install -y conda-build
    
    - name: Build conda package
      shell: bash -l {0}
      run: |
        conda build . --output-folder build --no-verify
    
    - name: Install anaconda-client
      if: success()
      shell: bash -l {0}
      run: |
        conda install -y anaconda-client
    
    - name: Upload to Anaconda
      if: success()
      shell: bash -l {0}
      env:
        ANACONDA_USERNAME: ${{ secrets.ANACONDA_USERNAME }}      
        ANACONDA_PASSWORD: ${{ secrets.ANACONDA_PASSWORD }}
      run: |
        anaconda -t $ANACONDA_PASSWORD upload -u $ANACONDA_USERNAME build/noarch/emumadz-*.tar.bz2